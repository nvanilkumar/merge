{% block content %}
    <!DOCTYPE html>
    <html>
        <head>    
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <!-- import Google font -->
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
            <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css">
            <link href="{{ asset('assets/css/bootstrap.min.css')}}" rel="stylesheet" type="text/css" />
            <!-- Login Page CSS -->
            <link rel="stylesheet" href="{{ asset('assets/css/widget-style.css')}}" type="text/css" />

            <script src="{{asset('assets/plugins/jQuery/jQuery-2.2.0.min.js')}}"></script>
            <script src="{{asset('assets/js/config.js')}}"></script>
            <script src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>	
            <title>Widget</title>
        </head>
        <body class="" >  

            <div class="widget-container" id="widget-container">
                <div class="menu">
                    <div class="container-fluid">
                        <div class="navbar-header">
                            <a href="javascript:;">Scopdial</a>
                        </div>
                        <div>
                            <ul class="nav navbar-nav navbar-right">
                                <li><a href="javascript:;" id="widget-close" ><i class="fa fa-minus" aria-hidden="true"></i></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="spacer120"></div>
                <div class="container container-fluid">
                    <div class="row ">
                        <div class="col-xs-12 col-sm-12 col-md-12">
                            <div class="notice notice-lg notice-success online-controls" id="astrisklogin">
                                <strong><i class="fa fa-asterisk fa-2x" aria-hidden="true"></i> Connected</strong> You have successfully logged in as Agent.
                                <button type="button " class="btn btn-danger hangupagentaction pull-right"><i class="fa fa-ban" aria-hidden="true"></i> Hangup Agent</button>
                            </div>

                            <div class="panel panel-default live-controls" id="campaign-running-status">
                                <div class="panel-heading"><h3 id="campain_name">Campaign title</h3>
                                    <button type="button " class="btn btn-danger hangupagentaction"><i class="fa fa-ban" aria-hidden="true"></i> Hangup Agent</button>
                                </div>
                                <div class="panel-body">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" aria-valuenow="70"
                                             aria-valuemin="0" aria-valuemax="100" style="width:70%" id="status_bar">
                                            <span id="status_bar_percentage"> 60% Complete of 3/5 Records</span> 
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="well well-sm live-controls" id="customer-details">
                                <div class="row">
                                    <div class="col-sm-3 col-md-3">
                                        <div class="panel panel-default">
                                            <div class="panel-heading">
                                                <div class="row">

                                                    <div class="col-lg-6 text-right">
                                                        <span class="label label-default " id="callTimer" style="font-size: 1.2em !important;">00:00:00</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="panel-body">
                                                <p><span class="label currentcall-status label-info" style="font-size: 1.4em !important;" id ="dialing">Dialing ...</span></p>
                                                <p><span class="label currentcall-status label-success" style="font-size: 1.4em !important;" id ="answering">Answered</span></p>
                                                <p><span class="label currentcall-status label-warning" style="font-size: 1.4em !important;" id ="ended">Call Ended</span></p>
                                                <p><span class="label currentcall-status label-danger" style="font-size: 1.4em !important;" id ="dnd">DND</span></p>
                                                <p><span class="label currentcall-status label-default" style="font-size: 1.4em !important;" id ="nr">Not Reachable</span></p>
                                                <p><span class="label currentcall-status label-default" style="font-size: 1.4em !important;" id ="failed">Call failed</span></p>

                                                <button type="button " id="showonlyonanswered" class="btn btn-danger hangupagentaction">
                                                    End Call
                                                </button>


                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-3 col-md-3">

                                        <div class="panel panel-default">
                                            <div class="panel-heading"><h4 id="customer-customername">Bhaumik Patel</h4></div>
                                            <div class="panel-body">
                                                <p>
                                                    <i class="fa fa-phone" aria-hidden="true"></i>&nbsp;<span id="customer-phonenumber">9898755895</span>
                                                    <br />
                                                    <i class="fa fa-building" aria-hidden="true"></i>&nbsp;<span id="customer-company">ACME Pvt. Ltd.</span>
                                                    <br />
                                                    <i class="fa fa-link" aria-hidden="true"></i>&nbsp;<span id="customer-acc_code">6756</span></p>

                                                <div>
                                                    <label> Dail Status</label>

                                                    <select id="customer-status-code" name="cust_">
                                                        <option value="0">Please Select the option</option>
                                                        <option value="1">Busy</option>
                                                        <option value="3">Answered</option>
                                                        <option value="2">Call back  </option>
                                                        <option value="4">DND</option>
                                                        <option value="5">No Answer</option>
                                                        <option value="6">Unreachable</option>
                                                        <option value="7">Voicemail</option>
                                                    </select> 
                                                </div>    

                                            </div>
                                        </div>





                                    </div>
                                    <div class="col-sm-6 col-md-6">

                                        <div class="panel panel-default">
                                            <div class="panel-heading"><h4>Upcoming Customer</h4></div>
                                            <div class="panel-body">
                                                <table width="100%" class="table table-striped table-bordered">
                                                    <thead>
                                                        <tr><th>Name</th><th>Number</th><th>Acc Code</th><th></th></tr>   
                                                    </thead>
                                                    <tbody id="all-customers">
                                                        <tr><td colspan="4">No upcomming customers</td></tr> 

                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>




                                    </div>
                                </div>
                            </div>
                            <div class="notice notice-lg notice-warning offline-controls" id="notlivealert">
                                <strong><i class="fa fa-exclamation-triangle fa-2x" aria-hidden="true"></i> Oh snap</strong> Looks like none of the campaign are running at this moment.
                            </div>
                            <div class="notice notice-lg notice-danger offline-controls" id="invalidconfig">
                                <strong><i class="fa fa-exclamation-triangle fa-2x" aria-hidden="true"></i> Warning</strong> Please check and correct the configuration of this Widget.
                            </div>

                        </div>
                    </div>
                </div>

            </div>

            <div class="widget-closed-container" id="widget-closed-container" style="display:none;">
                <div class="menu">
                    <div class="container-fluid">
                        <div class="navbar-header">
                            <a href="javascript:;">Scopdial</a> <a href="javascript:;" id="widget-open"><i class="fa fa-expand" aria-hidden="true"></i></a>
                        </div>
                       
                    </div>
                </div>
            </div>


        </body>
        <script src="{{asset('assets/plugins/timer.jquery.min.js')}}"></script>
        <script src="{{asset('assets/js/autobahn.min.js')}}" type="text/javascript"></script>
        <script type="text/javascript">
            var campaignid = 0;
            var connecttowss = false;
            var ext = '{{ extension }}';
            var config = '{{ config }}';
            var astrisklogin = false;
            var runningcamp = false;
            // changeCampaignStatus();
            toggleLoginStatus('offline');

            changeCurrentcallStatus('');
            $('#upcoming-customers').show();
            $('#livecampaings').hide();
            $('.customer-control').hide();
            $('#astrisklogin').hide();
            // $('.pause-campaign').hide();
            //$('.resume-campaign').hide();

            $.ajax({
                url: "{{url('_widget_get_agent_status')}}",
                type: "POST",
                data: "agentext=" + ext,
                dataType: "json",
                success: function (response)
                {
                    console.log(response);
                    if (response.status == "success" && response.response.astrisk_login == 1)
                    {
                        astrisklogin = true;
                        $('#astrisklogin').show();
                        toggleLoginStatus('online');
                    } else {

                    }
                }

            });
            $(document).ready(function () {
                $('#widget-close').show();
                $('#widget-open').show();

                $('body').on('click', '#widget-close', function () {
                    $("#widget-container").hide();
                    $("#widget-closed-container").show();
                });
                $('body').on('click', '#widget-open', function () {
                    $("#widget-container").show();
                    $("#widget-closed-container").hide();
                });

                $('#example').DataTable();
                $("input:radio").attr('disabled', true);
            });
            function toggleLoginStatus(state)
            {
                if (state == 'online')
                {
                    $('.hangupagentaction').attr('disabled', false);
                    if (runningcamp == true) {
                        $('.live-controls').show();
                    }
                    $('.offline-controls').hide();
                } else
                {
                    $("#callTimer").timer('remove');
                    $('.live-controls').hide();
                    $('.offline-controls').show();
                    if (config == false)
                    {
                        $('#notlivealert').hide();

                    } else
                    {
                        $('#invalidconfig').hide();
                    }
                }
                if (astrisklogin == true && runningcamp == false)
                {
                    $('#astrisklogin').show();
                } else
                {
                    $('#astrisklogin').hide();
                }
            }

            function changeCurrentcallStatus(state) //$(".call-timer").timer('remove'); _agent_toggle_campaign_status
            {
                if (state == '')
                {
                    $('.currentcall-status').hide();
                } else
                {
                    $('.currentcall-status').hide();
                    $('#' + state).show();
                }
            }

            function updateCustomerTab(type, customerphone, campaign_id)
            { //
                $.ajax({
                    url: "{{url('_widget_get_customer_details')}}",
                    type: "POST",
                    data: "customerphone=" + customerphone + "&campaign_id=" + campaign_id,
                    dataType: "json",
                    success: function (response)
                    {
                        console.log(response);
                        if (response.status == "success")
                        {
                            toggleLoginStatus('online');
                            $('#livecampaings').show();
                            if (response.hasOwnProperty('campdata'))
                            {
                                // alert('got');
                                changeCampaignStatus(response.campdata)
                            }
                            if (response.hasOwnProperty('response'))
                            {
                                // alert('got');
                                changeCustomerStatus(response.response, campaign_id)
                            }

                            if (type == 'call_initiated')
                            {
                                $('#showonlyonanswered').hide();
                                $("#noCampaigns").hide();
                                $('.customer-control').show();
                                changeCurrentcallStatus('dialing');
                            } else if (type == 'call_answered')
                            {
                                $('#showonlyonanswered').show();
                                $("#noCampaigns").hide();
                                $('.customer-control').show();
                                changeCurrentcallStatus('answering');
                                $('#callTimer').timer({
                                    seconds: 0, //Specify start time in seconds
                                    format: '%H:%M:%S'
                                });
                            } else if (type == 'call_ended')
                            {
                                $('#showonlyonanswered').hide();
                                $("#noCampaigns").hide();
                                $('.customer-control').show();
                                changeCurrentcallStatus('ended');
                                $("#callTimer").timer('remove');
                            } else if (type == 'call_failed')
                            {
                                $('#showonlyonanswered').hide();
                                $("#noCampaigns").hide();
                                $('.customer-control').show();
                                changeCurrentcallStatus('failed');
                                $("#callTimer").timer('remove');
                            }
                        } else {

                        }
                    }

                });

                $.ajax({
                    url: "{{url('_widget_agent_get_campcustomer_details')}}",
                    type: "POST",
                    data: "campaign_id=" + campaign_id,
                    dataType: "json",
                    success: function (response)
                    {
                        console.log(response);
                        if (response.status == "success")
                        { //all-customers
                            var ht = '';
                            $.each(response.response, function (key, val) {
                                //alert(key + val);
                                var skipper = '';
                                if (val.skipped_by != 0)
                                {
                                    skipper = '<button type="button" data-cdid = "' + val.cd_id + '" data-skip = "yes"  class="btn btn-warning skippcall-control">Skiped</button>';
                                } else
                                {
                                    skipper = '<button type="button" data-cdid = "' + val.cd_id + '" data-skip = "yes"  class="btn btn-default skippcall-control">Skip call</button>';
                                }
                                ht += '<tr><td>' + val.title + ' ' + val.first_name + ' ' + val.last_name + '</td><td><a href="#">' + val.phone_number + '</a></td><td><a href="#">' + val.acc_code + '</a></td><td>' + skipper + '</td></tr>';
                            });
                            $('#all-customers').html(ht);
                        } else {
                            $('#all-customers').html('<tr><td colspan="4">No upcomming customers</td></tr> ');
                        }
                    }

                });



            }

            $('body').on('click', '.skippcall-control', function () {
                var cdid = $(this).attr('data-cdid');
                var skip = $(this).attr('data-skip');
                var dis = $(this);
                $.ajax({
                    url: "{{url('_widget_agent_skipp_call')}}",
                    type: "POST",
                    data: "cd_id=" + cdid + '&ext=' + ext,
                    dataType: "json",
                    success: function (response)
                    {
                        console.log(response);
                        if (response.status == "success")
                        {
                            if (response.response == 0)
                            { //btn-warning
                                dis.removeClass('btn-warning');
                                dis.addClass('btn-default');
                                dis.html('Skip call');

                            } else
                            {
                                dis.addClass('btn-warning');
                                dis.removeClass('btn-default');
                                dis.html('Skiped');
                            }
                        } else {

                        }
                    }

                });
            });
            function changeCampaignStatus(statusInformation) {
                //var statusInformation = {totalUsers: 10, completedUsers: 5, campaignName: "MAK Campaing"};

                //percentage
                var ispaused = parseInt(statusInformation.isPaused);
                if (ispaused == 1)
                {
                    //  $('.pause-campaign').hide();
                    //  $('.resume-campaign').show();
                } else
                {
                    // $('.resume-campaign').hide();
                    // $('.pause-campaign').show();
                }
                var statusPercentage = parseInt(statusInformation.completedUsers) * 100 / parseInt(statusInformation.totalUsers);

                $("#campain_name").html(statusInformation.campaignName);
                $("#status_bar").css('width', parseInt(statusPercentage) + "%");
                $("#status_bar_data").html(parseInt(statusPercentage) + "% Complete of " + statusInformation.completedUsers +
                        "/" + statusInformation.totalUsers + " Records");
                $("#status_bar_percentage").html(parseInt(statusPercentage) + "% Complete of " + statusInformation.completedUsers +
                        "/" + statusInformation.totalUsers + " Records");
            }
            function changeCustomerStatus(statusInformation, campaign_id) {
                // customer-customername customer-phonenumber customer-company customer-acc_code
                $('#customer-customername').html(statusInformation.title + ' ' + statusInformation.first_name + ' ' + statusInformation.last_name);
                $('#customer-phonenumber').html(statusInformation.phone_number);
                $('#customer-company').html(statusInformation.company);
                $('#customer-acc_code').html(statusInformation.acc_code);
                $('#customer-status-code').attr("name", campaign_id);
                $('#customer-status-code').attr("data-customer-id", statusInformation.customer_id);
            }


            if (config == true) {
                var conn = new ab.Session(wss_subscriber,
                        function () {

                            conn.subscribe(ext, function (topic, data) {
                                var obj = $.parseJSON(data);
                                // This is where you would add the new article to the DOM (beyond the scope of this tutorial)
                                console.log(data);
                                status = obj.type;
                                if (status == 'agent_login') {
                                    console.log(obj);
                                    astrisklogin = true;
                                    toggleLoginStatus('online');
                                    // alert('got it');
                                    //  ws.subscribe('test');
                                }
                                if (status == 'agent_logout') {
                                    campaignid = 0;
                                    astrisklogin = false;
                                    runningcamp = false;
                                    toggleLoginStatus('offline');

                                }
                                if (status == 'call_answered') {
                                    campaignid = obj.campaign_id;
                                    toggleLoginStatus('online');
                                    runningcamp = true;
                                    updateCustomerTab(status, obj.customerphone, obj.campaign_id);

                                }
                                if (status == 'call_initiated') {
                                    campaignid = obj.campaign_id;
                                    toggleLoginStatus('online');
                                    runningcamp = true;
                                    updateCustomerTab(status, obj.customerphone, obj.campaign_id);

                                }
                                if (status == 'call_ended') {
                                    campaignid = obj.campaign_id;
                                    toggleLoginStatus('online');
                                    runningcamp = true;
                                    updateCustomerTab(status, obj.customerphone, obj.campaign_id);

                                }
                                if (status == 'call_failed') {
                                    campaignid = obj.campaign_id;
                                    toggleLoginStatus('online');
                                    runningcamp = true;
                                    updateCustomerTab(status, obj.customerphone, obj.campaign_id);

                                }
                            });
                        },
                        function () {
                            console.warn('WebSocket connection closed');
                        },
                        {'skipSubprotocolCheck': true}
                );
            }

            $('body').on('click', '.hangupagentaction', function ()
            {
                $(this).attr('disabled', true);
                var hanged = 0;
                $.ajax({
                    url: "{{url('_widget_hangup_agent')}}",
                    type: "POST",
                    data: 'ext=' + ext,
                    dataType: "json",
                    success: function (response)
                    {
                        if (response.status == "success")
                        {
                            if (response.response == 'yes') {
                                hanged = 1;
                                dummyCall();
                            }
                        } else {

                        }
                    }

                });

            });

            function dummyCall()
            {
                $.ajax({
                    url: '{{ url('pamitets') }}',
                    type: "GET",
                    success: function (response)
                    {
                        if (response.status == "error")
                        {

                        } else {

                        }
                    }
                });
            }

            //change the customer answer status
            //_update_call_status
            $('body').on('change', '#customer-status-code', function () {
                var campain_id = $(this).attr('name');
                var customer_id = $(this).data('customer-id');
                var cbval = $(this).val();
            {#           console.log(cbname +"#######"+cbval);#}
                    $.ajax({
                        url: "{{url('_widget_update_call_status')}}",
                        type: "POST",
                        data: "campain_id=" + campain_id + "&customer_id=" + customer_id + "&dsid=" + cbval + '&ext=' + ext,
                        dataType: "json",
                        success: function (response)
                        {
                            console.log(response);
                            if (response.status == "success")
                            {
                                $('#list-item-' + response.cd_id).html(response.response);
                            } else {

                            }
                        }

                    });
                });
        </script>
    </html>

{% endblock %} 